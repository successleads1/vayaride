<!DOCTYPE html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin â€¢ Trips</title>
<style>
:root{--bg:#000;--card:#0f0f0f;--text:#fff;--muted:#bbb;--border:#222;--ok:#1f6feb;--cash:#00c853;--warn:#f39c12}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
.layout{display:flex;min-height:100vh}
aside{width:240px;border-right:1px solid var(--border);background:#0a0a0a;padding:16px;position:sticky;top:0;height:100vh}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.brand img{width:44px;height:44px;border-radius:50%;border:2px solid #fff}
.brand h1{font-size:16px;margin:0}
nav a{display:block;padding:10px;border-radius:8px;text-decoration:none;color:#fff;border:1px solid transparent}
nav a:hover{background:#101010;border-color:#222}
main{flex:1;padding:20px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
h2{margin:0 0 10px;font-size:18px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px dashed #222;text-align:left;vertical-align:top}
.filter{margin-bottom:10px;color:#bbb}
.badge{padding:4px 8px;border-radius:999px;border:1px solid #333;background:#111;font-size:12px}
.badge.cash{border-color:#134e1f;background:#0b2e13;color:#b7ffcc}
.badge.card{border-color:#113659;background:#0b2033;color:#cfe6ff}
.sub{color:#bbb;font-size:12px}
td.nowrap{white-space:nowrap}
a.link{color:#7aa2ff;text-decoration:none}
a.link:hover{text-decoration:underline}
.coords{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;color:#a9a9a9}
</style></head><body>
<div class="layout">
  <aside>
    <div class="brand">
      <img src="https://res.cloudinary.com/darf17drw/image/upload/v1752064092/Untitled_design_2_wilxrl.png" alt="">
      <h1>VayaRide Admin</h1>
    </div>
    <nav>
      <a href="/admin">Dashboard</a>
      <a href="/admin/drivers">Drivers</a>
      <!-- âœ… Added Riders link -->
      <a href="/admin/riders">Riders</a>
      <a href="/admin/trips">Trips</a>
    </nav>
    <form action="/admin/logout" method="POST" style="margin-top:12px">
      <button style="background:#111;color:#fff;border:1px solid #222;padding:8px 10px;border-radius:8px;cursor:pointer">Logout</button>
    </form>
  </aside>
  <main>
    <section class="card">
      <h2>Trips</h2>
      <div class="filter">Filter:
        <a href="/admin/trips">All</a> â€¢
        <a href="/admin/trips?status=pending">Pending</a> â€¢
        <a href="/admin/trips?status=accepted">Accepted</a> â€¢
        <a href="/admin/trips?status=enroute">En Route</a> â€¢
        <a href="/admin/trips?status=completed">Completed</a> â€¢
        <a href="/admin/trips?status=cancelled">Cancelled</a>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Trip</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Driver</th>
            <th>Pickup / Drop</th>
            <th>Created</th>
            <th class="nowrap">Action</th>
          </tr>
        </thead>
        <tbody>
          <% trips.forEach(t => { 
               const idShort = String(t._id).slice(-6).toUpperCase();
               const pm = (t.paymentMethod || '').toLowerCase();
               const isCash = pm === 'cash';
               const isCard = ['payfast','app','paypal'].includes(pm);
               const pmLabel = isCash ? 'Cash' : (pm ? pm.toUpperCase() : 'â€”');
               const cancelKm = (typeof t.cancelDistanceKm === 'number') ? t.cancelDistanceKm.toFixed(2) : null;
               const pickup = t.pickup ? `${Number(t.pickup.lat).toFixed(5)},${Number(t.pickup.lng).toFixed(5)}` : null;
               const drop   = t.destination ? `${Number(t.destination.lat).toFixed(5)},${Number(t.destination.lng).toFixed(5)}` : null;
               const gmap = (latlng) => `https://maps.google.com/?q=${latlng}`;
          %>
            <tr>
              <td>
                Trip <%= idShort %>
                <% if (t.status === 'cancelled' && cancelKm != null) { %>
                  <div class="sub">Cancelled @ ~<%= cancelKm %> km</div>
                <% } %>
                <% if (t.status === 'completed' && typeof t.finalDistanceKm === 'number') { %>
                  <div class="sub">Final: ~<%= Number(t.finalDistanceKm).toFixed(2) %> km</div>
                <% } %>
              </td>

              <td>
                <span class="badge"><%= t.status %></span>
              </td>

              <td>
                <% if (isCash) { %>
                  <span class="badge cash">ðŸ’µ <%= pmLabel %></span>
                <% } else if (isCard) { %>
                  <span class="badge card">ðŸ’³ <%= pmLabel %></span>
                <% } else { %>
                  <span class="badge"><%= pmLabel %></span>
                <% } %>
                <% if (t.paymentStatus === 'paid') { %>
                  <div class="sub">Paid <%= t.paidAt ? new Date(t.paidAt).toLocaleString() : '' %></div>
                <% } %>
              </td>

              <td>
                <%= (t.driverId && (t.driverId.name || t.driverId.email)) || '-' %>
              </td>

              <td>
                <% if (pickup) { %>
                  <div class="coords">Pickup: <a class="link" href="<%= gmap(pickup) %>" target="_blank"><%= pickup %></a></div>
                <% } else { %>
                  <div class="coords">Pickup: â€”</div>
                <% } %>
                <% if (drop) { %>
                  <div class="coords">Drop: <a class="link" href="<%= gmap(drop) %>" target="_blank"><%= drop %></a></div>
                <% } else { %>
                  <div class="coords">Drop: â€”</div>
                <% } %>

                <% if (t.status === 'cancelled' && t.cancelDriverLoc && typeof t.cancelDriverLoc.lat === 'number' && typeof t.cancelDriverLoc.lng === 'number') { 
                     const c = `${Number(t.cancelDriverLoc.lat).toFixed(5)},${Number(t.cancelDriverLoc.lng).toFixed(5)}`;
                %>
                  <div class="coords">Cancel@Drv: <a class="link" href="<%= gmap(c) %>" target="_blank"><%= c %></a></div>
                <% } %>
              </td>

              <td><%= new Date(t.createdAt).toLocaleString() %></td>

              <td class="nowrap"><a href="/admin/trips/<%= t._id %>">Open</a></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </section>
  </main>
</div>
</body></html>
