<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Ä¢ Prebook</title>
<style>
:root{
  --bg:#000;--card:#0f0f0f;--text:#fff;--muted:#bbb;--border:#222;
  --accent:#1b3ea4;--danger:#a33;--ok:#00e676
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
a{color:#fff}
.layout{display:flex;min-height:100vh}
aside{width:240px;border-right:1px solid var(--border);background:#0a0a0a;padding:16px;position:sticky;top:0;height:100vh}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.brand img{width:44px;height:44px;border-radius:50%;border:2px solid #fff}
.brand h1{font-size:16px;margin:0}
nav a{display:block;padding:10px;border-radius:8px;text-decoration:none;color:#fff;border:1px solid transparent}
nav a:hover{background:#101010;border-color:#222}

main{flex:1;padding:20px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
h2{margin:0 0 10px;font-size:18px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px dashed #222;text-align:left;vertical-align:top}
.input{background:#0b0b0b;border:1px solid var(--border);color:#fff;padding:10px 12px;border-radius:8px;min-width:220px}
.btn{background:#111;border:1px solid #333;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
.btn.small{font-size:12px;padding:6px 8px}
.btn.primary{background:#0b1433;border-color:var(--accent)}
.badge{padding:6px 10px;border-radius:999px;background:#111;border:1px solid #222}
.badge.ok{background:#07150a;border-color:#113e1b;color:#bdf3bd}
.badge.warn{background:#140a07;border-color:#3e1b11;color:#f3c9bd}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
</style>
</head>
<body>
<div class="layout">
  <aside>
    <div class="brand">
      <img src="https://res.cloudinary.com/darf17drw/image/upload/v1752064092/Untitled_design_2_wilxrl.png" alt="">
      <h1>VayaRide Admin</h1>
    </div>
    <nav>
      <a href="/admin">Dashboard</a>
      <a href="/admin/drivers">Drivers</a>
      <a href="/admin/riders">Riders</a>
      <a href="/admin/trips">Trips</a>
      <a href="/admin/prebook"><b>Prebook</b></a>
    </nav>
    <form action="/admin/logout" method="POST" style="margin-top:12px">
      <button class="btn" type="submit">Logout</button>
    </form>
  </aside>

  <main>
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <h2>Prebook (Scheduled) Trips</h2>
      </div>

      <% const _q = (typeof q === 'string' ? q : ''); %>
      <% const _assigned = (typeof assigned === 'string' ? assigned : ''); %>
      <% const _from = (typeof from === 'string' ? from : ''); %>
      <% const _to = (typeof to === 'string' ? to : ''); %>
      <% const _pg = (pagination && pagination.page) ? pagination : { page:1, totalPages:1, limit:20 }; %>

      <!-- Filters -->
      <form class="row" method="GET" action="/admin/prebook">
        <input class="input" type="text" name="q" placeholder="Search rider/driver/email/phone/id‚Ä¶" value="<%= _q %>"/>

        <select class="input" name="assigned">
          <% const _ass = String(_assigned||'').toLowerCase(); %>
          <option value="">All</option>
          <option value="unassigned" <%= _ass==='unassigned' ? 'selected' : '' %>>Unassigned only</option>
          <option value="assigned"   <%= _ass==='assigned' ? 'selected' : '' %>>Assigned only</option>
        </select>

        <input class="input" type="date" name="from" value="<%= _from %>"/>
        <input class="input" type="date" name="to"   value="<%= _to %>"/>
        <input type="hidden" name="page" value="1"/>
        <button class="btn" type="submit">Filter</button>
      </form>

      <table class="table">
        <thead>
          <tr>
            <th>When</th>
            <th>Rider</th>
            <th>Pickup ‚Üí Destination</th>
            <th>Driver</th>
            <th>Vehicle</th>
            <th>Status</th>
            <th>Assign</th>
          </tr>
        </thead>
        <tbody>
          <% if (!rides || rides.length===0) { %>
            <tr><td colspan="7" class="small">No scheduled trips.</td></tr>
          <% } %>

          <% (rides||[]).forEach(r => { %>
            <tr>
              <td>
                <div><b><%= r.scheduledFor ? new Date(r.scheduledFor).toLocaleString() : '‚Äî' %></b></div>
                <div class="small muted">Created: <%= r.createdAt ? new Date(r.createdAt).toLocaleString() : '‚Äî' %></div>
              </td>

              <!-- Rider -->
              <td>
                <div><b><%= r._ui?.riderName || (r.riderId?.name || r.rider?.name) || '‚Äî' %></b></div>
                <div class="small"><%= r._ui?.riderPhone || (r.riderId?.phone || r.rider?.phone || r.riderId?.msisdn || r.rider?.msisdn) || '‚Äî' %></div>
              </td>

              <!-- Pickup / Destination -->
              <td>
                <div>
                  üìç
                  <span class="loc"
                        data-role="pickup"
                        data-lat="<%= (r.pickup && typeof r.pickup.lat === 'number') ? r.pickup.lat : '' %>"
                        data-lng="<%= (r.pickup && typeof r.pickup.lng === 'number') ? r.pickup.lng : '' %>">
                    <%= (r._ui?.pickupLabel && r._ui.pickupLabel.trim())
                          ? r._ui.pickupLabel
                          : ((r.pickup?.lat!=null && r.pickup?.lng!=null) ? `${Number(r.pickup.lat).toFixed(5)}, ${Number(r.pickup.lng).toFixed(5)}` : '‚Äî') %>
                  </span>
                </div>

                <div>
                  üèÅ
                  <span class="loc"
                        data-role="dest"
                        data-lat="<%= (r.destination && typeof r.destination.lat === 'number') ? r.destination.lat : '' %>"
                        data-lng="<%= (r.destination && typeof r.destination.lng === 'number') ? r.destination.lng : '' %>">
                    <%= (r._ui?.destLabel && r._ui.destLabel.trim())
                          ? r._ui.destLabel
                          : ((r.destination?.lat!=null && r.destination?.lng!=null) ? `${Number(r.destination.lat).toFixed(5)}, ${Number(r.destination.lng).toFixed(5)}` : '‚Äî') %>
                  </span>
                </div>
              </td>

              <!-- Driver -->
              <td>
                <% const dd = r.driverId || r.driver || null; %>
                <% if (dd) { %>
                  <div><b><%= dd.name || '‚Äî' %></b></div>
                  <div class="small"><%= dd.phone || '‚Äî' %></div>
                <% } else { %>
                  <span class="small muted">Unassigned</span>
                <% } %>
              </td>

              <td><%= r.vehicleType || '‚Äî' %></td>

              <td>
                <% if (!r.driverId && !r.driver) { %>
                  <span class="badge warn small">Unassigned</span>
                <% } else { %>
                  <span class="badge ok small">Assigned</span>
                <% } %>
              </td>

              <td>
                <form onsubmit="return false" style="display:flex;gap:6px;align-items:center">
                  <select class="input" style="min-width:220px" id="drv-<%= r._id %>">
                    <option value="">‚Äî select driver ‚Äî</option>
                    <% (drivers||[]).forEach(d => { %>
                      <option value="<%= d._id %>" <%= (r.driverId && String(r.driverId._id)===String(d._id)) || (r.driver && String(r.driver._id)===String(d._id)) ? 'selected':'' %>>
                        <%= d.name || 'Unnamed' %> ‚Ä¢ <%= d.vehicleType || '‚Äî' %> ‚Ä¢ <%= d.phone || '' %>
                      </option>
                    <% }) %>
                  </select>
                  <button class="btn small primary" onclick="assignDriver('<%= r._id %>')">Assign</button>
                  <% if (r.driverId || r.driver) { %>
                    <button class="btn small" onclick="unassignDriver('<%= r._id %>')">Unassign</button>
                  <% } %>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- Pager -->
      <div class="row">
        <% const mk = (p)=>`/admin/prebook?q=${encodeURIComponent(_q)}&assigned=${encodeURIComponent(_assigned)}&from=${encodeURIComponent(_from)}&to=${encodeURIComponent(_to)}&page=${p}&limit=${_pg.limit}` %>
        <% if (_pg.page > 1) { %>
          <a class="btn small" href="<%= mk(1) %>">¬´ First</a>
          <a class="btn small" href="<%= mk(_pg.page-1) %>">‚Äπ Prev</a>
        <% } else { %>
          <span class="btn small" style="opacity:.5">¬´ First</span>
          <span class="btn small" style="opacity:.5">‚Äπ Prev</span>
        <% } %>
        <span class="small">Page <b><%= _pg.page %></b> / <%= _pg.totalPages %></span>
        <% if (_pg.page < _pg.totalPages) { %>
          <a class="btn small" href="<%= mk(_pg.page+1) %>">Next ‚Ä∫</a>
          <a class="btn small" href="<%= mk(_pg.totalPages) %>">Last ¬ª</a>
        <% } else { %>
          <span class="btn small" style="opacity:.5">Next ‚Ä∫</span>
          <span class="btn small" style="opacity:.5">Last ¬ª</span>
        <% } %>
      </div>
    </section>
  </main>
</div>

<script>
// ===== assign / unassign =====
async function assignDriver(rideId){
  const sel = document.getElementById('drv-'+rideId);
  const driverId = sel?.value || '';
  if (!driverId) { alert('Pick a driver first.'); return; }
  try{
    const r = await fetch(`/admin/prebook/${rideId}/assign`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ driverId })
    });
    // when route responds with redirect HTML, ignore; we just refresh
    if (r.headers.get('content-type')?.includes('application/json')) {
      const data = await r.json();
      if (!data.ok) throw new Error(data.error||'Failed');
    }
    location.reload();
  }catch(e){
    alert('Assign failed: '+(e?.message||e));
  }
}

async function unassignDriver(rideId){
  if (!confirm('Unassign this driver?')) return;
  try{
    const r = await fetch(`/admin/prebook/${rideId}/unassign`, { method:'POST' });
    if (r.headers.get('content-type')?.includes('application/json')) {
      const data = await r.json();
      if (!data.ok) throw new Error(data.error||'Failed');
    }
    location.reload();
  }catch(e){
    alert('Unassign failed: '+(e?.message||e));
  }
}

// ===== reverse-geocode coords -> names (calls /admin/geocode) =====
(async () => {
  const isCoord = s => /^-?\d{1,3}\.\d+\s*,\s*-?\d{1,3}\.\d+$/.test((s||'').trim());
  const els = document.querySelectorAll('.loc[data-lat][data-lng]');
  for (const el of els) {
    const current = (el.textContent || '').trim();
    if (!isCoord(current)) continue;
    const lat = Number(el.dataset.lat);
    const lng = Number(el.dataset.lng);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

    try {
      const r = await fetch(`/admin/geocode?lat=${lat}&lng=${lng}`, { headers: { 'Accept': 'application/json' } });
      if (!r.ok) continue;
      const j = await r.json();
      if (j && j.ok && j.name) el.textContent = j.name;
    } catch (_) {}
  }
})();
</script>
</body>
</html>
