<!DOCTYPE html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Driver</title>
<style>
:root{--bg:#000;--card:#0f0f0f;--text:#fff;--muted:#bbb;--border:#222;--ok:#00e676;--err:#ff4d4d;--star:#ffd34d;--star-bg:#333}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
.layout{display:flex;min-height:100vh}
aside{width:240px;border-right:1px solid var(--border);background:#0a0a0a;padding:16px;position:sticky;top:0;height:100vh}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.brand img{width:44px;height:44px;border-radius:50%;border:2px solid #fff}
.brand h1{font-size:16px;margin:0}
nav a{display:block;padding:10px;border-radius:8px;text-decoration:none;color:#fff;border:1px solid transparent}
nav a:hover{background:#101010;border-color:#222}
main{flex:1;padding:20px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
h2{margin:0 0 10px;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px dashed #222;text-align:left}
.btn{appearance:none;background:#111;border:1px solid #333;color:#fff;padding:10px 12px;border-radius:8px;text-decoration:none;cursor:pointer}
.btn.approve{border-color:#0f4;background:linear-gradient(0deg,#0c0,#0f0);color:#000;font-weight:800}
.btn.reject{border-color:#400;background:linear-gradient(0deg,#f33,#f99);color:#000;font-weight:800}
.badge{padding:6px 10px;border-radius:999px;background:#111;border:1px solid #222}
.pin{font-size:20px;font-weight:800;letter-spacing:2px}
.thumb{width:72px;height:72px;border:1px solid #222;border-radius:8px;object-fit:cover;background:#111}

/* ⭐ star bar */
.stars{position:relative;display:inline-block;line-height:1;color:var(--star-bg);font-size:18px}
.stars::before{content:'★★★★★';letter-spacing:1px}
.stars .fill{position:absolute;inset:0 0 0 0;white-space:nowrap;overflow:hidden;width:0;color:var(--star)}
.stars .fill::before{content:'★★★★★';letter-spacing:1px}
.muted{color:var(--muted)}
.kv{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.kv b{min-width:110px;display:inline-block}
.kvmini{display:grid;grid-template-columns:auto 1fr;gap:4px 10px}
</style></head><body>
<div class="layout">
  <aside>
    <div class="brand">
      <img src="https://res.cloudinary.com/darf17drw/image/upload/v1752064092/Untitled_design_2_wilxrl.png" alt="">
      <h1>VayaRide Admin</h1>
    </div>
    <nav>
      <a href="/admin">Dashboard</a>
      <a href="/admin/drivers">Drivers</a>
    </nav>
    <form action="/admin/logout" method="POST" style="margin-top:12px">
      <button class="btn" type="submit">Logout</button>
    </form>
  </aside>
  <main>
    <section class="card">
      <h2>Driver</h2>
      <div class="grid">
        <div>
          <div class="kv"><b>Name:</b> <span><%= d.name %></span></div>
          <div class="kv"><b>Email:</b> <span><%= d.email || '—' %></span></div>
          <div class="kv"><b>Phone:</b> <span><%= d.phone || '—' %></span></div>
          <div class="kv"><b>Vehicle:</b> <span><%= d.vehicleType || '-' %></span></div>
          <div class="kv"><b>Status:</b> <span class="badge"><%= d.status %></span></div>

          <% /* ⭐ Rating row (avg + stars + count) */ %>
          <% const avg = Number(d?.stats?.avgRating || 0); %>
          <% const cnt = Number(d?.stats?.ratingsCount || 0); %>
          <% const pct = Math.min(100, Math.max(0, (avg / 5) * 100)); %>
          <div class="kv" style="margin-top:10px">
            <b>Rating:</b>
            <span class="stars" title="<%= avg.toFixed(2) %> / 5 from <%= cnt %> ratings">
              <span class="fill" style="width:<%= pct %>%"></span>
            </span>
            <span>&nbsp;<b><%= avg.toFixed(2) %></b> / 5</span>
            <span class="muted">(<%= cnt %> ratings)</span>
          </div>

          <div class="kv" style="margin-top:8px">
            <b>Trips:</b>
            <span><b><%= Number(d?.stats?.totalTrips||0) %></b> total •
              cash <b><%= Number(d?.stats?.cashCount||0) %></b> • pay/app <b><%= Number(d?.stats?.payfastCount||0) %></b>
              <% if (Number(d?.stats?.cashCount||0) >= 3) { %>
                <span class="badge" style="margin-left:6px;background:#4d1a1a;border-color:#a33;color:#ffb3b3">MAX REACHED</span>
              <% } %>
            </span>
          </div>

          <% if (d.status === 'approved' && d.botPin) { %>
            <div style="margin-top:10px"><b>Telegram PIN:</b> <span class="pin"><%= d.botPin %></span></div>
            <div class="muted" style="font-size:13px;margin-top:6px;">Share this PIN with the driver (shown on their dashboard). They’ll use it to log in to the Telegram driver bot.</div>
          <% } %>
        </div>

        <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap">
          <form method="POST" action="/admin/drivers/<%= d._id %>/approve">
            <button class="btn approve" type="submit">Approve + Generate PIN</button>
          </form>
          <form method="POST" action="/admin/drivers/<%= d._id %>/reject">
            <button class="btn reject" type="submit">Reject</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Banking details -->
    <section class="card">
      <h2>Banking</h2>
      <% const b = d?.banking || {}; %>
      <div class="kvmini">
        <div><b>Account Holder:</b> <span><%= b.accountHolder || '—' %></span></div>
        <div><b>Bank:</b> <span><%= b.bankName || '—' %></span></div>
        <div><b>Account Type:</b> <span><%= b.accountType || '—' %></span></div>
        <div><b>Account Number:</b> <span><%= b.accountNumber || '—' %></span></div>
        <div><b>Branch / Universal:</b> <span><%= b.branchCode || '—' %></span></div>
        <div><b>SWIFT/BIC:</b> <span><%= b.swift || '—' %></span></div>
        <div><b>Updated:</b> <span><%= b.updatedAt ? new Date(b.updatedAt).toLocaleString() : '—' %></span></div>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px">These details are visible to admins only and used for payouts.</div>
    </section>

    <section class="card">
      <h2>Documents</h2>
      <% const docs = d.documents || {}; %>
      <table class="table">
        <thead><tr><th>Preview</th><th>Type</th><th>Link</th></tr></thead>
        <tbody>
          <% [
            ['driverProfilePhoto','Driver Profile Photo'],
            ['vehiclePhoto','Vehicle Photo'],
            ['idDocument','National ID'],
            ['vehicleRegistration','Vehicle Registration'],
            ['driversLicense','Driver’s License'],
            ['insuranceCertificate','Insurance Certificate'],
            ['pdpOrPsv','PDP / PSV'],
            ['dekraCertificate','DEKRA Certificate'],
            ['policeClearance','Police Clearance'],
            ['licenseDisc','License Disc']
          ].forEach(([key,label]) => {
              const url = docs[key];
              const isImg = url && /\.(jpg|jpeg|png|webp|gif)(\?|$)/i.test(url);
              const isPdf = url && /\.pdf(\?|$)/i.test(url);
          %>
          <tr>
            <td>
              <% if (url && isImg) { %>
                <img class="thumb" src="<%= url %>" alt="<%= label %>"/>
              <% } else if (url) { %>
                <div class="thumb" style="display:flex;align-items:center;justify-content:center;">PDF</div>
              <% } else { %>
                —
              <% } %>
            </td>
            <td><%= label %></td>
            <td>
              <% if (url) { %>
                <a class="btn" href="<%= url %>" target="_blank" rel="noopener">Open</a>
              <% } else { %> — <% } %>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </section>
  </main>
</div>
</body></html>
